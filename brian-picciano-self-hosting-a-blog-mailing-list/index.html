<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="referrer" content="no-referrer">

        <!-- Enable responsiveness on mobile devices-->
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />

        <title>Self-Hosting a Blog Mailing List | Cryptic – Blog</title>
<meta content="Self-Hosting a Blog Mailing List | Cryptic – Blog" property="og:title"/><meta content="Self-Hosting a Blog Mailing List | Cryptic – Blog" name="twitter:title"/>

        

        <meta property="og:site_name" content="Cryptic – Blog" />
        <meta property="og:url" content="https:&#x2F;&#x2F;blog.cryptic.io" />

        


        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https:&#x2F;&#x2F;blog.cryptic.io&#x2F;base.css" />
        <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro&display=swap" rel="stylesheet">
        <link href="https:&#x2F;&#x2F;blog.cryptic.io&#x2F;fontawesome&#x2F;fontawesome.css" rel="stylesheet">
        <link href="https:&#x2F;&#x2F;blog.cryptic.io&#x2F;fontawesome&#x2F;brands.css" rel="stylesheet">
        <link href="https:&#x2F;&#x2F;blog.cryptic.io&#x2F;fontawesome&#x2F;solid.css" rel="stylesheet">

        <link rel='icon' type='image/x-icon' href="https:&#x2F;&#x2F;blog.cryptic.io&#x2F;favicon.ico" />

        <link rel="alternate" type="application/atom+xml" title="Cryptic – Blog" href="https:&#x2F;&#x2F;blog.cryptic.io&#x2F;atom.xml">

        

    </head>
    <body>
        <a href="#main" class="skip-link p-screen-reader-text">Skip to content</a>
        <header class="l-header">
            <h1 class="c-title p-title"><a href="https:&#x2F;&#x2F;blog.cryptic.io" class="p-title__link">Cryptic – Blog</a></h1>
            </header>

        <main id="main" class="l-main">
            <article class="p-article">
<header>
  <h1>Self-Hosting a Blog Mailing List
</h1>
  <div>
    <div class="c-time">
      <time datetime="2021-08-04">
        2021-08-04
      </time>
      by Brian Picciano
       - (10 min read)
    </div>
  </div>
</header>

<section class="p-article__body" id="js-article">
  <p>As of this week the Mediocre Blog has a new follow mechanism: email! <a href="/follow.html">Sign up
on the <strong>Follow</strong> page</a> and you’ll get an email everytime a new post
is published to the blog. It’s like RSS, except there’s a slight chance you
might actually use it.</p>

<p>This post will detail my relatively simple setup for this, linking to points
within my blog’s server code which are relevant. While I didn’t deliberately
package my code up into a nice public package, if you know have some cursory
knowledge of Go you could probably rip my code and make it work for you. Don’t
worry, it has a <a href="/assets/wtfpl.txt">permissive license</a>.</p>

<h2 id="email-server">Email Server</h2>

<p>Self-hosting email is the hardest and most foreign part of this whole
thing for most devs. The long and the short of it is that it’s very unlikely you
can do this without renting a VPS somewhere. Luckily there are VPSs out there
which are cheap and which allow SMTP traffic, so it’s really just a matter of
biting the cost bullet and letting your definition of “self-hosted” be a bit
flexible. At least you still control the code!</p>

<p>I highly recommend <a href="https://maddy.email">maddy</a> as an email server which has everything you
need out of the box, no docker requirements, and a flexible-yet-simple
configuration language.  I’ve discussed <a href="/2021/07/06/maddy-vps.html">in previous posts</a> the
general steps I’ve used to set up maddy on a remote VPS, and so I won’t
re-iterate here. Just know that I have a VPS on my private <a href="https://github.com/slackhq/nebula">nebula</a> VPN,
with a maddy server listening for outgoing mail on port 587, with
username/password authentication on that port.</p>

<h2 id="general-api-design">General API Design</h2>

<p>The rest of the system lies within the Go server which hosts my blog. There is
only a single instance of the server, and it runs in my living room. With these
as the baseline environmental requirements, the rest of the design follows
easily:</p>

<ul>
  <li>
    <p>The Go server provides <a href="https://github.com/mediocregopher/blog.mediocregopher.com/blob/5ca7dadd02fb49dd62ad448d12021359e41beec1/srv/cmd/mediocre-blog/main.go#L169">three REST API endpoints</a>:</p>

    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">POST /api/mailinglist/subscribe</code>: Accepts a POST form argument <code class="language-plaintext highlighter-rouge">email</code>, sends a
verification email to that email address.</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">POST /api/mailinglist/finalize</code>: Accepts a POST form argument <code class="language-plaintext highlighter-rouge">subToken</code>,
which is a random token sent to the user when they subscribe. Only by
finalizing their subscription can a user be considered actually
subscribed.</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">POST /api/mailinglist/unsubscribe</code>: Accepts a POST form argument
<code class="language-plaintext highlighter-rouge">unsubToken</code>, which is sent with each blog post notification to the user.</p>
      </li>
    </ul>
  </li>
  <li>
    <p>The static frontend code has <a href="https://github.com/mediocregopher/blog.mediocregopher.com/tree/9c3ea8dd803d6f0df768e3ae37f8c4ab2efbcc5c/static/src/mailinglist">two pages</a> related to the mailing
list:</p>

    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">/mailinglist/finalize.html</code>: The verification email which is sent to the
user links to this page, with the <code class="language-plaintext highlighter-rouge">subToken</code> as a GET argument. This page
then submits the <code class="language-plaintext highlighter-rouge">subToken</code> to the <code class="language-plaintext highlighter-rouge">POST /api/mailinglist/finalize</code>
endpoint.</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">/mailinglist/unsubscribe.html</code>: Each blog post notification email sent to
users contains a link to this page, with an <code class="language-plaintext highlighter-rouge">unsubToken</code> as a GET
argument. This page then submits the <code class="language-plaintext highlighter-rouge">unsubToken</code> to the <code class="language-plaintext highlighter-rouge">POST
/api/mailinglist/unsubscribe</code> endpoint.</p>
      </li>
    </ul>
  </li>
</ul>

<p>It’s a pretty small API, but it covers all the important things, namely
verification (because I don’t want people signed up against their will, nor do I
want to be sending emails to fake email addresses), and unsubscribing.</p>

<h2 id="proof-of-work">Proof-of-work</h2>

<p>It was important to me that someone couldn’t just sit and submit random emails
to the <code class="language-plaintext highlighter-rouge">POST /api/mailinglist/subscribe</code> endpoint in a loop, causing my email
server to eventually get blacklisted. To prevent this I’ve implemented a simple
proof-of-work (PoW) system, whereby the client must first obtain a PoW
challenge, generate a solution for that challenge (which involves a lot of CPU
time), and then submit that solution as part of the subscribe endpoint call.</p>

<p>Both the <a href="https://github.com/mediocregopher/blog.mediocregopher.com/blob/9c3ea8dd803d6f0df768e3ae37f8c4ab2efbcc5c/srv/pow/pow.go">server-side</a> and <a href="https://github.com/mediocregopher/blog.mediocregopher.com/blob/9c3ea8dd803d6f0df768e3ae37f8c4ab2efbcc5c/static/src/assets/solvePow.js">client-side</a> code can be found
in the blog’s git repo. You could theoretically view the Go documentation for
the server code on pkg.go.dev, but apparently their bot doesn’t like my WTFPL.</p>

<p>When providing a challenge to the client, the server sends back two values: the
seed and the target.</p>

<p>The target is simply a number whose purpose will become apparent in a second.</p>

<p>The seed is a byte-string which encodes:</p>

<ul>
  <li>
    <p>Some random bytes.</p>
  </li>
  <li>
    <p>An expiration timestamp.</p>
  </li>
  <li>
    <p>A target (matching the one returned to the client alongside the seed).</p>
  </li>
  <li>
    <p>An HMAC-MD5 which signs all of the above.</p>
  </li>
</ul>

<p>When the client submits a valid solution the server checks the HMAC to ensure
that the seed was generated by the server, it checks the expiration to make sure
the client didn’t take too long to solve it, and it checks in an <a href="https://github.com/mediocregopher/blog.mediocregopher.com/blob/5ca7dadd02fb49dd62ad448d12021359e41beec1/srv/pow/store.go">internal
storage</a> whether that seed hasn’t already been solved. Because
the expiration is built into the seed the server doesn’t have to store each
solved seed forever, only until the seed has expired.</p>

<p>To generate a solution to the challenge the client does the following:</p>

<ul>
  <li>
    <p>Concatenate up to <code class="language-plaintext highlighter-rouge">len(seed)</code> random bytes onto the original seed given by the
server.</p>
  </li>
  <li>
    <p>Calculate the SHA512 of that.</p>
  </li>
  <li>
    <p>Parse the first 4 bytes of the resulting hash as a big-endian uint32.</p>
  </li>
  <li>
    <p>If that uint32 is less than the target then the random bytes generated in the
first step are a valid solution. Otherwise the client loops back to the first
step.</p>
  </li>
</ul>

<p>Finally, a new endpoint was added: <code class="language-plaintext highlighter-rouge">GET /api/pow/challenge</code>, which returns a PoW
seed and target for the client to solve. Since seeds don’t require storage in a
database until <em>after</em> they are solved there are essentially no consequences to
someone spamming this in a loop.</p>

<p>With all of that in place, the <code class="language-plaintext highlighter-rouge">POST /api/mailinglist/subscribe</code> endpoint
described before now also requires a <code class="language-plaintext highlighter-rouge">powSeed</code> and a <code class="language-plaintext highlighter-rouge">powSolution</code> argument. The
<a href="/follow.html">Follow</a> page, prior to submitting a subscribe request, first retrieves
a PoW challenge, generates a solution, and only <em>then</em> will it submit the
subscribe request.</p>

<h2 id="storage">Storage</h2>

<p>Storage of emails is fairly straightforward: since I’m not running this server
on multiple hosts, I can just use <a href="https://sqlite.org/index.html">SQLite</a>. My code for storage in
SQLite can all be found <a href="https://github.com/mediocregopher/blog.mediocregopher.com/blob/5ca7dadd02fb49dd62ad448d12021359e41beec1/srv/mailinglist/store.go">here</a>.</p>

<p>My SQLite table has a single table:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CREATE TABLE emails (
	id          TEXT PRIMARY KEY,
	email       TEXT NOT NULL,
	sub_token   TEXT NOT NULL,
	created_at  INTEGER NOT NULL,

	unsub_token TEXT,
	verified_at INTEGER
)
</code></pre></div></div>

<p>It will probably one day need an index on <code class="language-plaintext highlighter-rouge">sub_token</code> and <code class="language-plaintext highlighter-rouge">unsub_token</code>, but I’m
not quite there yet.</p>

<p>The <code class="language-plaintext highlighter-rouge">id</code> field is generated by first lowercasing the email (because emails are
case-insensitive) and then hashing it. This way I can be sure to identify
duplicates easily. It’s still possible for someone to do the <code class="language-plaintext highlighter-rouge">+</code> trick to get
their email in multiple times, but as long as they verify each one I don’t
really care.</p>

<h2 id="publishing">Publishing</h2>

<p>Publishing is quite easy: my <a href="https://github.com/mediocregopher/blog.mediocregopher.com/blob/5ca7dadd02fb49dd62ad448d12021359e41beec1/srv/mailinglist/mailinglist.go#L23">MailingList interface</a> has a
<code class="language-plaintext highlighter-rouge">Publish</code> method on it, which loops through all records in the SQLite table,
discards those which aren’t verified, and sends an email to the rest containing:</p>

<ul>
  <li>
    <p>A pleasant greeting.</p>
  </li>
  <li>
    <p>The new post’s title and URL.</p>
  </li>
  <li>
    <p>An unsubscribe link.</p>
  </li>
</ul>

<p>I will then use a command-line interface to call this <code class="language-plaintext highlighter-rouge">Publish</code> method. I
haven’t actually made that interface yet, but no one is subscribed yet so it
doesn’t matter.</p>

<h2 id="easy-peasy">Easy-Peasy</h2>

<p>The hardest part of the whole thing was probably getting maddy set up, with a
close second being trying to decode a hex string to a byte string in javascript
(I tried Crypto-JS, but it wasn’t working without dragging in webpack or a bunch
of other nonsense, and vanilla JS doesn’t have any way to do it!).</p>

<p>Hopefully reading this will make you consider self-hosting your own blog’s
mailing list as well. If we let these big companies keep taking over all
internet functionality then eventually they’ll finagle the standards so that
no one can self-host anything, and we’ll have to start all over.</p>

<p>And really, do you <em>need</em> tracking code on the emails you send out for your
recipe blog? Just let your users ignore you in peace and quiet.</p>
</section>
<footer>
  <nav class="c-pagination p-pagination">
    <div class="c-pagination__ctrl">
      <div class="c-pagination__newer">
        <a href="https:&#x2F;&#x2F;blog.cryptic.io&#x2F;brian-picciano-the-syntax-of-ginger&#x2F;">The Syntax of Ginger</a>
      </div>
      <div class="c-pagination__older">
        <a href="https:&#x2F;&#x2F;blog.cryptic.io&#x2F;brian-picciano-v4-of-radix-a-golang-redis-driver&#x2F;">V4 of Radix, a Golang Redis Driver</a>
      </div>
    </div>
  </nav>
</footer></article>
        </main>

     
      <footer class="l-footer">
          <p class="p-copyright">
              
          </p>
      </footer>

       
      
    </body>
</html>
            
